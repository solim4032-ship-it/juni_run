<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Juni Run</title>

<style>
body {
    margin: 0;
    background: #87CEEB;
    font-family: Arial Black, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

/* ê³µí†µ í™”ë©´ */
.screen {
    position: fixed;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* ì‹œì‘ í™”ë©´ */
#startScreen {
    background: linear-gradient(#8fd3f4, #84fab0);
}

button {
    padding: 12px 35px;
    font-size: 22px;
    font-weight: bold;
    margin: 10px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
}

/* ê²Œì„ */
#game {
    display: none;
    width: 100vw;
    max-width: 1200px;
    height: 450px;
    background: url("background.png") no-repeat center center;
    background-size: cover;
    position: relative;
    overflow: hidden;
    border-radius: 20px;
}

#juni {
    width: 80px;
    position: absolute;
    bottom: 0;
    left: 100px;
}

.obstacle {
    position: absolute;
    bottom: 0;
}

#scoreBoard {
    position: absolute;
    top: 15px;
    left: 20px;
    font-size: 24px;
    color: white;
    text-shadow: 2px 2px 5px black;
}

/* ë­í‚¹ */
#rankingScreen {
    display: none;
    background: linear-gradient(#a1c4fd, #c2e9fb);
}

input {
    padding: 10px;
    font-size: 18px;
    margin: 5px;
}
#bestScoreBoard{
    position:absolute;
    top:50px;
    left:20px;
    font-size:22px;
    color:white;
    text-shadow:2px 2px 5px black;
}

#backBtn{
    position:absolute;
    top:15px;
    right:20px;
    font-size:18px;
    padding:6px 15px;
}

#rankingList {
    margin-top: 20px;
    width: 300px;
    max-height: 300px;
    overflow-y: auto;
}

.rankItem {
    padding: 8px;
    margin: 5px 0;
    background: white;
    border-radius: 8px;
    font-size: 18px;
}

.highlight {
    background: gold;
    font-size: 22px;
    font-weight: bold;
    border: 3px solid red;
}
</style>
</head>

<body>

<!-- ì‹œì‘ í™”ë©´ -->
<div id="startScreen" class="screen">
    <h2>ì—¬ìì¹œêµ¬ë¥¼ ë°Ÿì§€ ì•Šê²Œ ì¡°ì‹¬í•˜ì!</h2>
    <h1 style="font-size:70px;">Juni Run</h1>
    <button onclick="startGame()">ì‹œì‘í•˜ê¸°</button>
    <button onclick="openRanking()">ë­í‚¹</button>
</div>

<!-- ê²Œì„ -->
<div id="game">
    <div id="scoreBoard">Time: 0s</div>
    <div id="bestScoreBoard">Best: 0s</div>
    <button id="backBtn" onclick="backToStart()">Back</button>
    <img id="juni" src="juni.png">
</div>

<!-- ë­í‚¹ í™”ë©´ -->
<div id="rankingScreen" class="screen">
    <h1>ë­í‚¹</h1>
    <input id="username" placeholder="ì´ë¦„">
    <input id="password" placeholder="ë¹„ë°€ë²ˆí˜¸(ìˆ«ìë§Œ)" type="password" inputmode="numeric">
    <button onclick="login()">í™•ì¸</button>
    <div id="rankingList"></div>
    <button onclick="goBack()">Back</button>
</div>

<script>
let currentUser = null;
let bestTime = 0;
let time = 0;
let speed = 6;
let gameOver = false;
let obstacleInterval, timerInterval;

const game = document.getElementById("game");
const juni = document.getElementById("juni");
const scoreBoard = document.getElementById("scoreBoard");
const bestScoreBoard = document.getElementById("bestScoreBoard");


/* í™”ë©´ ì „í™˜ */
function startGame(){
    document.getElementById("startScreen").style.display="none";
    game.style.display="block";

    bestScoreBoard.innerHTML = "Best: " + bestTime + "s";

    resetGame();
}

function openRanking(){
    document.getElementById("startScreen").style.display="none";
    document.getElementById("rankingScreen").style.display="flex";
}

function goBack(){
    document.getElementById("rankingScreen").style.display="none";
    document.getElementById("startScreen").style.display="flex";
}

/* ë¡œê·¸ì¸ */
function login(){
    let name = document.getElementById("username").value.trim();
    let pw = document.getElementById("password").value.trim();

    if(!/^[0-9]+$/.test(pw)){
        alert("ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
    }

    let users = JSON.parse(localStorage.getItem("users") || "{}");

    if(users[name]){
        if(users[name].pw !== pw){
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            return;
        }
    } else {
        users[name] = { pw: pw, best: 0 };
    }

    currentUser = name;
    bestTime = users[name].best;
    localStorage.setItem("users", JSON.stringify(users));

    showOnlineRanking();
}

/* ë­í‚¹ í‘œì‹œ */
function showRanking(){
    let users = JSON.parse(localStorage.getItem("users") || "{}");
    let arr = [];

    for(let name in users){
        arr.push({name:name, best:users[name].best});
    }

    arr.sort((a,b)=>b.best-a.best);

    let list = document.getElementById("rankingList");
    list.innerHTML="";

    arr.forEach((u,i)=>{
        let div = document.createElement("div");
        div.className="rankItem";
        div.innerHTML=(i+1)+"ë“± - "+u.name+" : "+u.best+"s";

        if(u.name===currentUser){
            div.classList.add("highlight");
        }

        list.appendChild(div);
    });
}

/* ì í”„ */
document.addEventListener("keydown", e=>{
    if(e.code==="Space"){
        if(gameOver){
            resetGame();
        } else {
            jump();
        }
    }
});

function jump(){
    if(gameOver) return;

    juni.src = "juni_jump.png";  

    let height=0;
    let up=setInterval(()=>{
        if(height>=130){
            clearInterval(up);
            let down=setInterval(()=>{
                if(height<=0){
                    clearInterval(down);
                    juni.src = "juni.png";
                }
                height-=6;
                juni.style.bottom=height+"px";
            },20);
        }
        height+=6;
        juni.style.bottom=height+"px";
    },20);
}

/* ì¥ì• ë¬¼ */
function createObstacle(){
    let obstacle=document.createElement("img");

    if(time>=30 && Math.random()<0.25){
        obstacle.src="obstacle2.png";
        obstacle.style.width="80px";
    } else {
        obstacle.src="obstacle1.png";
        obstacle.style.width="60px";
    }

    obstacle.className="obstacle";
    obstacle.style.left=game.offsetWidth+"px";
    game.appendChild(obstacle);

    let move=setInterval(()=>{
        if(gameOver){clearInterval(move);return;}

        let jr=juni.getBoundingClientRect();
        let or=obstacle.getBoundingClientRect();

        if(jr.right-20>or.left+15 && jr.left+20<or.right-15 && jr.bottom-10>or.top+10){

    obstacle.src = "obstacle2.png";  

    gameOver=true;
    clearInterval(obstacleInterval);
    clearInterval(timerInterval);

    saveScore();
    saveOnlineScore(currentUser, time);

    setTimeout(()=>{
        alert("ê²Œì„ì˜¤ë²„! ìŠ¤í˜ì´ìŠ¤ë¡œ ì¬ì‹œì‘");
    },200);
}

        obstacle.style.left=obstacle.offsetLeft-speed+"px";

        if(obstacle.offsetLeft<-120){
            obstacle.remove();
            clearInterval(move);
        }
    },20);
}

/* ì ìˆ˜ ì €ì¥ */
function saveScore(){
    if(!currentUser) return;

    let users=JSON.parse(localStorage.getItem("users"));
    if(time>users[currentUser].best){
    users[currentUser].best=time;
    bestTime=time;
    bestScoreBoard.innerHTML = "Best: " + bestTime + "s";
    localStorage.setItem("users",JSON.stringify(users));
}
}

/* ê²Œì„ ë¦¬ì…‹ */
function resetGame(){
    document.querySelectorAll(".obstacle").forEach(o=>o.remove());
    gameOver=false;
    time=0;
    speed=6;
    scoreBoard.innerHTML="Time: 0s";

    obstacleInterval=setInterval(createObstacle,2000);
    timerInterval=setInterval(()=>{
        time++;
        speed+=0.2;
        scoreBoard.innerHTML="Time: "+time+"s";
    },1000);
}
function backToStart(){
    clearInterval(obstacleInterval);
    clearInterval(timerInterval);
    game.style.display="none";
    document.getElementById("startScreen").style.display="flex";
}
    
async function showOnlineRanking(){
    let rankingData = await loadOnlineRanking();

    let bestScores = {};

    rankingData.forEach(user=>{
        if(!bestScores[user.name] || user.score > bestScores[user.name]){
            bestScores[user.name] = user.score;
        }
    });

    let finalArray = [];
    for(let name in bestScores){
        finalArray.push({name:name, score:bestScores[name]});
    }

    finalArray.sort((a,b)=>b.score-a.score);

    let list = document.getElementById("rankingList");
    list.innerHTML="<h2>ğŸ† ì˜¨ë¼ì¸ ë­í‚¹</h2>";

    finalArray.forEach((user,index)=>{
        let div=document.createElement("div");
        div.className="rankItem";
        div.innerHTML=(index+1)+"ë“± - "+user.name+" : "+user.score+"s";

        if(user.name===currentUser){
            div.classList.add("highlight");
        }

        list.appendChild(div);
    });
}

    
</script>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC-GTDH9GtM0lZOfgpAGwIzqUJPvy12C80",
  authDomain: "juni-run.firebaseapp.com",
  projectId: "juni-run",
  storageBucket: "juni-run.firebasestorage.app",
  messagingSenderId: "349465222596",
  appId: "1:349465222596:web:05fa5296fa769e4d415891",
  measurementId: "G-KSMBMZKC2N"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.saveOnlineScore = async function(name, score){
    await addDoc(collection(db, "ranking"), {
        name: name,
        score: score,
        created: Date.now()
    });
}

window.loadOnlineRanking = async function(){
    const q = query(collection(db, "ranking"), orderBy("score", "desc"));
    const querySnapshot = await getDocs(q);
    let result = [];
    querySnapshot.forEach((doc) => {
        result.push(doc.data());
    });
    return result;
}
</script>

</body>
</html>
